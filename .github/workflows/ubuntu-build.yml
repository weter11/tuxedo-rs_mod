name: Ubuntu 24.04 Build and Package

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build and Package for Ubuntu 24.04
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libdbus-1-dev \
            pkg-config \
            libgtk-4-dev \
            libadwaita-1-dev \
            gettext \
            meson \
            ninja-build \
            desktop-file-utils \
            appstream

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache Cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build workspace binaries (tailord, tailor_cli)
        run: |
          cargo build --release
          ls -lh target/release/

      - name: Build and install tailor_gui with Meson
        run: |
          cd tailor_gui
          meson setup build --prefix=/usr -Dprofile=default
          meson compile -C build
          DESTDIR=$PWD/install-root meson install -C build
          ls -lh build/src/

      - name: Prepare tarball directory
        run: |
          mkdir -p tuxedo-rs-binaries/bin
          cp target/release/tailord tuxedo-rs-binaries/bin/
          cp target/release/tailor tuxedo-rs-binaries/bin/
          cp tailor_gui/build/src/tailor_gui tuxedo-rs-binaries/bin/
          
      - name: Create installation README for tarball
        run: |
          cat > tuxedo-rs-binaries/README.md << 'EOF'
          # Tuxedo-rs Binaries for Ubuntu 24.04
          
          This archive contains pre-built binaries for Tuxedo-rs.
          
          ## Contents
          
          - `bin/tailord` - System daemon for hardware control
          - `bin/tailor` - Command-line interface tool
          - `bin/tailor_gui` - GTK4/Libadwaita GUI application
          
          ## Installation
          
          ### Quick Installation
          
          ```bash
          # Copy binaries to /usr/local/bin (requires sudo)
          sudo cp bin/* /usr/local/bin/
          sudo chmod +x /usr/local/bin/tailord
          sudo chmod +x /usr/local/bin/tailor
          sudo chmod +x /usr/local/bin/tailor_gui
          ```
          
          ### Full Installation with systemd service
          
          For a complete installation with systemd service and D-Bus configuration,
          we recommend using the .deb package instead.
          
          ### Running the binaries
          
          ```bash
          # Start the daemon (requires root privileges)
          sudo tailord
          
          # Use the CLI
          tailor --help
          
          # Launch the GUI
          tailor_gui
          ```
          
          ## Notes
          
          - The daemon (tailord) requires root privileges to access hardware
          - Make sure you have the TUXEDO kernel drivers installed
          - For systemd integration, see the .deb package
          
          ## More Information
          
          Visit: https://github.com/AaronErhardt/tuxedo-rs
          EOF

      - name: Create tarball
        run: |
          tar -czf tuxedo-rs-ubuntu-24.04.tar.gz tuxedo-rs-binaries/
          ls -lh tuxedo-rs-ubuntu-24.04.tar.gz

      - name: Prepare Debian package structure
        run: |
          # Extract version from workspace Cargo.toml
          VERSION=$(grep -E '^\[workspace.package\]' -A 10 Cargo.toml | grep -E '^version\s*=' | head -n1 | cut -d'"' -f2)
          ARCH="amd64"
          PKG_DIR="tuxedo-rs_${VERSION}_${ARCH}"
          
          # Create directory structure
          mkdir -p ${PKG_DIR}/DEBIAN
          mkdir -p ${PKG_DIR}/usr/bin
          mkdir -p ${PKG_DIR}/usr/share/applications
          mkdir -p ${PKG_DIR}/usr/share/icons/hicolor/scalable/apps
          mkdir -p ${PKG_DIR}/usr/share/glib-2.0/schemas
          mkdir -p ${PKG_DIR}/usr/share/metainfo
          mkdir -p ${PKG_DIR}/etc/dbus-1/system.d
          mkdir -p ${PKG_DIR}/lib/systemd/system
          mkdir -p ${PKG_DIR}/usr/share/tailor_gui
          
          # Copy binaries
          cp target/release/tailord ${PKG_DIR}/usr/bin/
          cp target/release/tailor ${PKG_DIR}/usr/bin/
          cp tailor_gui/build/src/tailor_gui ${PKG_DIR}/usr/bin/
          # Copy GUI resources from meson install
          if [ -d tailor_gui/install-root/usr/share ]; then
            cp -r tailor_gui/install-root/usr/share/* ${PKG_DIR}/usr/share/
          fi
          
          # Copy D-Bus configuration
          cp tailord/com.tux.Tailor.conf ${PKG_DIR}/etc/dbus-1/system.d/
          
          # Create systemd service file
          cat > ${PKG_DIR}/lib/systemd/system/tailord.service << 'EOFS'
          [Unit]
          Description=Tux Tailor hardware control service
          After=systemd-logind.service
          
          [Service]
          Type=dbus
          BusName=com.tux.Tailor
          User=root
          ExecStart=/usr/bin/tailord
          Environment="RUST_BACKTRACE=1"
          
          [Install]
          WantedBy=multi-user.target
          EOFS
          
          # Copy GUI resources
          if [ -f tailor_gui/build/data/com.github.aaronerhardt.Tailor.desktop ]; then
            cp tailor_gui/build/data/com.github.aaronerhardt.Tailor.desktop ${PKG_DIR}/usr/share/applications/
          fi
          
          if [ -f tailor_gui/build/data/com.github.aaronerhardt.Tailor.gschema.xml ]; then
            cp tailor_gui/build/data/com.github.aaronerhardt.Tailor.gschema.xml ${PKG_DIR}/usr/share/glib-2.0/schemas/
          fi
          
          if [ -f tailor_gui/build/data/com.github.aaronerhardt.Tailor.metainfo.xml ]; then
            cp tailor_gui/build/data/com.github.aaronerhardt.Tailor.metainfo.xml ${PKG_DIR}/usr/share/metainfo/
          fi
          
          # Copy icons
          if [ -f tailor_gui/data/icons/com.github.aaronerhardt.Tailor.svg ]; then
            cp tailor_gui/data/icons/com.github.aaronerhardt.Tailor.svg ${PKG_DIR}/usr/share/icons/hicolor/scalable/apps/
          fi
          if [ -f tailor_gui/data/icons/com.github.aaronerhardt.Tailor-symbolic.svg ]; then
            cp tailor_gui/data/icons/com.github.aaronerhardt.Tailor-symbolic.svg ${PKG_DIR}/usr/share/icons/hicolor/scalable/apps/
          fi
          
          # Create control file
          cat > ${PKG_DIR}/DEBIAN/control << EOFC
          Package: tuxedo-rs
          Version: ${VERSION}
          Section: utils
          Priority: optional
          Architecture: amd64
          Depends: libdbus-1-3, libgtk-4-1, libadwaita-1-0
          Maintainer: Aaron Erhardt <aaron.erhardt@t-online.de>
          Description: Rust tools for TUXEDO Computers hardware
           Tuxedo-rs provides tools for controlling hardware on TUXEDO Computers.
           .
           This package includes:
            - tailord: System daemon for hardware control
            - tailor: Command-line interface tool
            - tailor_gui: GTK4/Libadwaita GUI application
          EOFC
          
          # Create postinst script
          cat > ${PKG_DIR}/DEBIAN/postinst << 'EOFP'
          #!/bin/bash
          set -e
          
          # Reload systemd daemon
          if [ -d /run/systemd/system ]; then
            systemctl daemon-reload >/dev/null 2>&1 || true
          fi
          
          # Compile glib schemas
          if [ -x /usr/bin/glib-compile-schemas ]; then
            glib-compile-schemas /usr/share/glib-2.0/schemas >/dev/null 2>&1 || true
          fi
          
          # Update icon cache
          if [ -x /usr/bin/gtk-update-icon-cache ]; then
            gtk-update-icon-cache -q -t -f /usr/share/icons/hicolor >/dev/null 2>&1 || true
          fi
          
          # Update desktop database
          if [ -x /usr/bin/update-desktop-database ]; then
            update-desktop-database -q /usr/share/applications >/dev/null 2>&1 || true
          fi
          
          exit 0
          EOFP
          chmod 755 ${PKG_DIR}/DEBIAN/postinst
          
          # Create prerm script
          cat > ${PKG_DIR}/DEBIAN/prerm << 'EOFR'
          #!/bin/bash
          set -e
          
          # Stop and disable service if it's running
          if [ -d /run/systemd/system ]; then
            if systemctl is-active --quiet tailord.service; then
              systemctl stop tailord.service >/dev/null 2>&1 || true
            fi
            if systemctl is-enabled --quiet tailord.service; then
              systemctl disable tailord.service >/dev/null 2>&1 || true
            fi
          fi
          
          exit 0
          EOFR
          chmod 755 ${PKG_DIR}/DEBIAN/prerm
          
          # Build the package
          dpkg-deb --build ${PKG_DIR}
          
          ls -lh ${PKG_DIR}.deb

      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: tuxedo-rs-ubuntu-24.04-tarball
          path: tuxedo-rs-ubuntu-24.04.tar.gz

      - name: Upload Debian package artifact
        uses: actions/upload-artifact@v4
        with:
          name: tuxedo-rs-ubuntu-24.04-deb
          path: "*.deb"
